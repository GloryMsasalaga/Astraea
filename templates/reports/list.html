{% extends 'dashboard.html' %}
{% load static %}

{% block title %}Reports - AuditFlow{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-navy mb-1">
                <i class="fas fa-chart-bar me-3 text-sky-blue"></i>
                Reports
            </h1>
            <p class="text-muted mb-0">Generate and manage financial reports</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-navy" onclick="scheduleReport()">
                <i class="fas fa-clock me-2"></i>Schedule Report
            </button>
            <button class="btn btn-sky-blue" data-bs-toggle="modal" data-bs-target="#generateModal">
                <i class="fas fa-plus me-2"></i>Generate Report
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card position-relative">
                <div class="kpi-value">47</div>
                <div class="kpi-label">Total Reports</div>
                <i class="fas fa-file-alt kpi-icon"></i>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card navy position-relative">
                <div class="kpi-value">12</div>
                <div class="kpi-label">This Month</div>
                <i class="fas fa-calendar kpi-icon"></i>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card success position-relative">
                <div class="kpi-value">5</div>
                <div class="kpi-label">Scheduled</div>
                <i class="fas fa-clock kpi-icon"></i>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="kpi-card coral position-relative">
                <div class="kpi-value">2.3GB</div>
                <div class="kpi-label">Storage Used</div>
                <i class="fas fa-hdd kpi-icon"></i>
            </div>
        </div>
    </div>

    <!-- Report Templates -->
    <div class="card mb-4 rounded-3 shadow-sm">
        <div class="card-header bg-light-gray">
            <h5 class="mb-0 text-navy">
                <i class="fas fa-template me-2"></i>Quick Report Templates
            </h5>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card h-100 border-sky-blue">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line text-sky-blue mb-3" style="font-size: 2.5rem;"></i>
                            <h6 class="card-title">Financial Summary</h6>
                            <p class="card-text text-muted small">Comprehensive overview of financial performance</p>
                            <button class="btn btn-sky-blue btn-sm" onclick="generateQuickReport('financial-summary')">
                                <i class="fas fa-play me-1"></i>Generate
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-navy">
                        <div class="card-body text-center">
                            <i class="fas fa-balance-scale text-navy mb-3" style="font-size: 2.5rem;"></i>
                            <h6 class="card-title">Reconciliation Report</h6>
                            <p class="card-text text-muted small">Detailed reconciliation status and discrepancies</p>
                            <button class="btn btn-navy btn-sm" onclick="generateQuickReport('reconciliation')">
                                <i class="fas fa-play me-1"></i>Generate
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-coral">
                        <div class="card-body text-center">
                            <i class="fas fa-receipt text-coral mb-3" style="font-size: 2.5rem;"></i>
                            <h6 class="card-title">Expense Analysis</h6>
                            <p class="card-text text-muted small">Breakdown of expenses by category and period</p>
                            <button class="btn btn-coral btn-sm" onclick="generateQuickReport('expense-analysis')">
                                <i class="fas fa-play me-1"></i>Generate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports List -->
    <div class="card rounded-3 shadow-sm">
        <div class="card-header bg-navy text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Generated Reports
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <select class="form-select form-select-sm text-dark" id="reportFilter" style="width: auto;">
                        <option value="">All Reports</option>
                        <option value="financial">Financial</option>
                        <option value="reconciliation">Reconciliation</option>
                        <option value="expense">Expense</option>
                        <option value="tax">Tax</option>
                    </select>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Type</th>
                            <th>Period</th>
                            <th>Generated</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    <div>
                                        <div class="fw-medium">Monthly Financial Summary - January 2024</div>
                                        <small class="text-muted">Comprehensive financial overview</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-sky-blue">Financial</span></td>
                            <td>Jan 1 - Jan 31, 2024</td>
                            <td>
                                <div>2024-02-01 09:30 AM</div>
                                <small class="text-muted">by {{ user.username }}</small>
                            </td>
                            <td><span class="badge-status completed">Ready</span></td>
                            <td>2.4 MB</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-sky-blue" onclick="downloadReport('report-1')" 
                                            data-bs-toggle="tooltip" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-navy" onclick="shareReport('report-1')"
                                            data-bs-toggle="tooltip" title="Share">
                                        <i class="fas fa-share"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-coral" onclick="deleteReport('report-1')"
                                            data-bs-toggle="tooltip" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-excel text-success me-2"></i>
                                    <div>
                                        <div class="fw-medium">Reconciliation Report - Q4 2023</div>
                                        <small class="text-muted">Bank reconciliation details</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-navy">Reconciliation</span></td>
                            <td>Oct 1 - Dec 31, 2023</td>
                            <td>
                                <div>2024-01-15 14:22 PM</div>
                                <small class="text-muted">by {{ user.username }}</small>
                            </td>
                            <td><span class="badge-status completed">Ready</span></td>
                            <td>1.8 MB</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-sky-blue" onclick="downloadReport('report-2')" 
                                            data-bs-toggle="tooltip" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-navy" onclick="shareReport('report-2')"
                                            data-bs-toggle="tooltip" title="Share">
                                        <i class="fas fa-share"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-coral" onclick="deleteReport('report-2')"
                                            data-bs-toggle="tooltip" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-chart-line text-sky-blue me-2"></i>
                                    <div>
                                        <div class="fw-medium">Expense Analysis by Category</div>
                                        <small class="text-muted">Detailed expense breakdown</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-coral">Expense</span></td>
                            <td>Dec 1 - Dec 31, 2023</td>
                            <td>
                                <div>2024-01-10 11:45 AM</div>
                                <small class="text-muted">by {{ user.username }}</small>
                            </td>
                            <td><span class="badge-status processing">Generating</span></td>
                            <td>-</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-coral" onclick="cancelReport('report-3')"
                                            data-bs-toggle="tooltip" title="Cancel">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-invoice text-warning me-2"></i>
                                    <div>
                                        <div class="fw-medium">Tax Preparation Summary</div>
                                        <small class="text-muted">Year-end tax preparation data</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-warning">Tax</span></td>
                            <td>Jan 1 - Dec 31, 2023</td>
                            <td>
                                <div>2024-01-05 16:30 PM</div>
                                <small class="text-muted">by {{ user.username }}</small>
                            </td>
                            <td><span class="badge-status completed">Ready</span></td>
                            <td>5.2 MB</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-sky-blue" onclick="downloadReport('report-4')" 
                                            data-bs-toggle="tooltip" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-navy" onclick="shareReport('report-4')"
                                            data-bs-toggle="tooltip" title="Share">
                                        <i class="fas fa-share"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-coral" onclick="deleteReport('report-4')"
                                            data-bs-toggle="tooltip" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3">
            <div class="modal-header bg-sky-blue text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Generate New Report
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="generateReportForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Report Type</label>
                            <select class="form-select" id="reportType" required>
                                <option value="">Select Report Type</option>
                                <option value="financial-summary">Financial Summary</option>
                                <option value="income-statement">Income Statement</option>
                                <option value="balance-sheet">Balance Sheet</option>
                                <option value="cash-flow">Cash Flow Statement</option>
                                <option value="reconciliation">Reconciliation Report</option>
                                <option value="expense-analysis">Expense Analysis</option>
                                <option value="tax-summary">Tax Summary</option>
                                <option value="custom">Custom Report</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Output Format</label>
                            <select class="form-select" id="outputFormat" required>
                                <option value="pdf">PDF Document</option>
                                <option value="xlsx">Excel Spreadsheet</option>
                                <option value="csv">CSV Data</option>
                                <option value="html">HTML Report</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Report Name</label>
                        <input type="text" class="form-control" id="reportName" placeholder="Enter a descriptive name for this report" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Include Sections</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeTransactions" checked>
                                    <label class="form-check-label" for="includeTransactions">
                                        Transaction Details
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                    <label class="form-check-label" for="includeCharts">
                                        Charts & Graphs
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                                    <label class="form-check-label" for="includeSummary">
                                        Executive Summary
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeReconciliation">
                                    <label class="form-check-label" for="includeReconciliation">
                                        Reconciliation Data
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeFootnotes">
                                    <label class="form-check-label" for="includeFootnotes">
                                        Footnotes & Assumptions
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeAppendix">
                                    <label class="form-check-label" for="includeAppendix">
                                        Supporting Documents
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Additional Notes</label>
                        <textarea class="form-control" id="reportNotes" rows="3" placeholder="Add any special instructions or notes for this report..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-navy" onclick="generateReport()">
                    <i class="fas fa-cogs me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Load reports data
    loadReportsData();
    
    // Set default dates
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // Report filter
    document.getElementById('reportFilter').addEventListener('change', function() {
        filterReports(this.value);
    });
});

function loadReportsData() {
    // Load reports via AJAX
    fetch('/api/reports/summary/')
        .then(response => response.json())
        .then(data => {
            // Update KPI cards with real data
            console.log('Reports data loaded:', data);
        })
        .catch(error => {
            console.error('Error loading reports data:', error);
        });
}

function generateQuickReport(type) {
    showToast(`Generating ${type} report...`, 'success');
    
    // Simulate report generation
    setTimeout(() => {
        showToast('Report generated successfully!', 'success');
        loadReportsData();
    }, 2000);
}

function generateReport() {
    const form = document.getElementById('generateReportForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        type: document.getElementById('reportType').value,
        format: document.getElementById('outputFormat').value,
        name: document.getElementById('reportName').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        include_transactions: document.getElementById('includeTransactions').checked,
        include_charts: document.getElementById('includeCharts').checked,
        include_summary: document.getElementById('includeSummary').checked,
        include_reconciliation: document.getElementById('includeReconciliation').checked,
        include_footnotes: document.getElementById('includeFootnotes').checked,
        include_appendix: document.getElementById('includeAppendix').checked,
        notes: document.getElementById('reportNotes').value
    };
    
    fetch('/api/reports/generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('generateModal')).hide();
        showToast('Report generation started. You will be notified when ready.', 'success');
        form.reset();
        loadReportsData();
    })
    .catch(error => {
        showToast('Error generating report: ' + error.message, 'error');
    });
}

function downloadReport(reportId) {
    showToast('Preparing download...', 'success');
    
    // Simulate download
    setTimeout(() => {
        showToast('Download started', 'success');
        // window.open(`/api/reports/${reportId}/download/`);
    }, 1000);
}

function shareReport(reportId) {
    const shareUrl = `${window.location.origin}/reports/shared/${reportId}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Financial Report',
            url: shareUrl
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('Share link copied to clipboard', 'success');
        });
    }
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        fetch(`/api/reports/${reportId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                showToast('Report deleted successfully', 'success');
                loadReportsData();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(error => {
            showToast('Error deleting report: ' + error.message, 'error');
        });
    }
}

function cancelReport(reportId) {
    if (confirm('Cancel report generation?')) {
        fetch(`/api/reports/${reportId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                showToast('Report generation cancelled', 'success');
                loadReportsData();
            }
        })
        .catch(error => {
            showToast('Error cancelling report: ' + error.message, 'error');
        });
    }
}

function scheduleReport() {
    showToast('Opening report scheduler...', 'success');
    // Open scheduling modal
}

function refreshReports() {
    loadReportsData();
    showToast('Reports refreshed', 'success');
}

function filterReports(type) {
    const rows = document.querySelectorAll('#reportsTableBody tr');
    
    rows.forEach(row => {
        if (type === '' || row.textContent.toLowerCase().includes(type.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function showToast(message, type) {
    const toastId = type === 'error' ? 'errorToast' : 'successToast';
    const messageId = type === 'error' ? 'errorToastMessage' : 'successToastMessage';
    
    document.getElementById(messageId).textContent = message;
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
}
</script>
{% endblock %}
